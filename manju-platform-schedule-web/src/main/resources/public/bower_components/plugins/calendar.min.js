/**
 *  Document   : calendar.js
 *  Author     : redstar
 *  Description: Script for calendar data
 *
 **/
var AppCalendar = function () {
    return {
        init: function () {
            this.initCalendar();
        },

        initCalendar: function () {


            if (jQuery().fullCalendar) {
                var e = new Date,
                    t = e.getDate(),
                    a = e.getMonth(),
                    n = e.getFullYear(),
                    r = {};
                $("#calendar").removeClass("mobile"), r = {
                    left: "prev,next,today",
                    center: "title",
                    right: "month,agendaWeek,agendaDay"
                };
                var l = function (e) {
                        var t = {
                            title: $.trim(e.text())
                        };
                        e.data("eventObject", t), e.draggable({
                            zIndex: 999,
                            revert: !0,
                            revertDuration: 0
                        })
                    },
                    o = function (e) {
                        e = 0 === e.length ? "Untitled Event" : e;
                        /* var t = $('<div class="external-event label label-event">' + e + "</div>");*/
                        var t = $('<div class="external-event label label-event-' + e + '">' + e + "</div>");
                        jQuery("#event_box").append(t), l(t)
                    };
                $("#external-events div.external-event").each(function () {
                    l($(this))
                }), $(document).on('click', '#event_add', function () {
                    var title = $("#event_title").val();

                    $.ajax({
                        url: "/calendar/add",
                        data: {title: title},
                        type: "post",
                        success: function (data) { //返回json结果
                            if (data["code"] == 400) {
                                alert(data["msg"]);
                                return;
                            }
                            $.ajax({
                                url: "/calendar/list",
                                data: {"userId": "test"},
                                type: "get",
                                success: function (data) { //返回json结果
                                    $("#event_box").empty();
                                    var da = data["extend"]["calendars"];
                                    for (var i in da) {
                                        o(da[i]["title"]);
                                    }
                                }
                            })
                        }
                    })
                }),
                    $.ajax({
                        url: "/calendar/list",
                        data: {"userId": "test"},
                        type: "get",
                        contentType: 'application/json;charset=utf-8',
                        success: function (data) { //返回json结果
                            var da = data["extend"]["calendars"];
                            for (var i in da) {
                                o(da[i]["title"]);
                            }
                        }
                    }),
                    $("#calendar").fullCalendar("destroy"),
                    $("#calendar").fullCalendar({
                        header: r,
                        defaultView: "month",
                        slotMinutes: 15,
                        editable: !0,
                        droppable: !0,


                        //    events: [{
                        //     title: "Annual Day",
                        //     start: new Date(n, a, t-5, 0, 0),
                        //     end: new Date(n, a, t-2, 0, 0),
                        //     backgroundColor: "#00FFFF"
                        // }],


                        drop: function (e, t) {
                            var a = $(this).data("eventObject"),
                                n = $.extend({}, a);
                            n.start = e, n.allDay = t, n.className = $(this).attr("data-class"), $("#calendar").fullCalendar("renderEvent", n, !0), $("#drop-remove").is(":checked") && $(this).remove()
                            var
                                userId="test",
                                title=a.title,
                                startTime=new Date().getTime(),
                                endTime=new Date().getTime(),
                                editTime=new Date().getTime();
                            var calendar={
                                userId:userId,
                                title:title,
                                startTime:startTime,
                                endTime:endTime,
                                editTime:editTime
                            }
                            $.ajax({
                                url: "/calendar/update",
                                data: JSON.stringify(calendar),
                                type: "post",
                                dataType:"json",
                                contentType:"application/json",
                                // contentType: 'application/json;charset=utf-8',
                                success: function (data) { //返回json结果
                                    if(data["code"]!=200){
                                        $('#calendar').fullCalendar('removeEvents', e.id);
                                    }
                                    $('#calendar').fullCalendar('updateEvent', event);
                                }
                            })
                        },
                        dayClick: function (event, jsEvent, view) {
                            alert(event);e
                        }
                        // ,eventMouseover: function(event, jsEvent, view){
                        //     alert(event);
                        // }
                        ,
                        eventResize : function(event, dayDelta, minuteDelta) {
                            var
                                userId="test",
                                title=event.title,
                                startTime=event.start.d.getTime(),
                                endTime=event.end.d.getTime(),
                                editTime=new Date().getTime();
                            var calendar={
                                userId:userId,
                                title:title,
                                startTime:startTime,
                                endTime:endTime,
                                editTime:editTime
                            }
                            $.ajax({
                                url: "/calendar/update",
                                data: JSON.stringify(calendar),
                                type: "post",
                                dataType:"json",
                                contentType:"application/json",
                                // contentType: 'application/json;charset=utf-8',
                                success: function (data) { //返回json结果
                                    alert("code");
                                }
                            })

                        },
                        /***** events ********/
                    //     $.ajax({
                    //     url: "/calendar/list",
                    //     data: {userId:"test"},
                    //     type: "get",
                    //     // contentType: 'application/json;charset=utf-8',
                    //     success: function (data) { //返回json结果
                    //         var da = data["extend"]["calendars"];
                    //         var title,start,end,backgroundColor;
                    //         var json=[];
                    //         for (var i in da) {
                    //             title=da[i]["title"];
                    //             start=new Date(da[i]["startTime"]);
                    //             end=new Date(da[i]["endTime"]);
                    //             backgroundColor="#00FFFF";
                    //             // var event={
                    //             //     title:title,start:start,end:end,backgroundColor:backgroundColor
                    //             // }
                    //             // json.push(event);
                    //         }
                    //
                    //
                    //
                    //         // events: JSON.stringify(json)
                    //
                    //     }
                    // })

                        events: function(start,end,callback){
                            $.ajax({
                                url: "/calendar/list",
                                data: {"userId": "test"},
                                type: "get",
                                success: function (data) { //返回json结果
                                    var events =[];
                                    $("#event_box").empty();
                                    var da = data["extend"]["calendars"];
                                    events.push({

                                }
                            })
                        }

                        // } ,
                        //
                        // events: function(start,end,callback){
                        //     var params = {};
                        //     $.ajax({
                        //         url:"/findCalendar",
                        //         type:"post",
                        //         data:params,
                        //         dataType: 'json',
                        //         success: function(res){
                        //             var events =[];
                        //             if(res.status==0){
                        //                 for(i in res.events){
                        //                     if(res.events[i].allDay == false){
                        //                         events.push({
                        //                             id:res.events[i]._id,
                        //                             title:res.events[i].title,
                        //                             start:new Date(res.events[i].y_start,res.events[i].m_start,res.events[i].d_start,res.events[i].hh_start,res.events[i].mm_start),
                        //                             end:new Date(res.events[i].y_end,res.events[i].m_end,res.events[i].d_end,res.events[i].hh_end,res.events[i].mm_end),
                        //                             allDay:false
                        //                         });
                        //                     }else{
                        //                         events.push({
                        //                             id:res.events[i]._id,
                        //                             title:res.events[i].title,
                        //                             start:new Date(res.events[i].y_start,res.events[i].m_start,res.events[i].d_start),
                        //                             end:new Date(res.events[i].y_end,res.events[i].m_end,res.events[i].d_end),
                        //                             allDay:true
                        //                         });
                        //                     }
                        //                 }
                        //                 try{
                        //                     //$("#success1").html(events[0].start+"*_*"+events[0].end);
                        //                     //$("#success1").show();
                        //                     callback(events);
                        //                 }catch(e){
                        //                     hc("div.fc-event");
                        //                     fc("span.fc-button");
                        //                 } finally {
                        //                     hc("div.fc-event");
                        //                     fc("span.fc-button");
                        //                 }
                        //
                        //             }
                        //         }
                        //     });
                        // } ,
                        //     title: "Annual Day",
                        //     start: new Date(n, a, t-5, 0, 0),
                        //     end: new Date(n, a, t-2, 0, 0),
                        //     backgroundColor: "#00FFFF"
                        // }, {
                        //     title: "Sports Event",
                        //     start: new Date(n, a, t-10, 9, 0),
                        //     end: new Date(n, a, t-8, 0, 0),
                        //     backgroundColor: "#F3565D"
                        // }, {
                        //     title: "Repeating Event",
                        //     start: new Date(n, a, t +5, 16, 0),
                        //     allDay: !1,
                        //     backgroundColor: "#1bbc9b"
                        // }, {
                        //     title: "Meeting",
                        //     start: new Date(n, a, t, 10, 30),
                        //     allDay: !1
                        // }, {
                        //     title: "Result Day",
                            //     start: new Date(n, a, t + 7, 19, 0),
                        //     end: new Date(n, a, t + 1, 22, 30),
                        //     backgroundColor: "#DC35A9",
                        //     allDay: !1
                        // }, {
                        //     title: "Click for Google",
                        //     start: new Date(n, a, 29),
                        //     end: new Date(n, a, 30),
                        //     backgroundColor: "#9b59b6",
                        //     url: "http://google.com/"
                        // }]
                    })
            }
        },
    }
}();
jQuery(document).ready(function () {
    'use strict';
    AppCalendar.init()
});

function timestampToTime(timestamp) {
    var date = new Date(timestamp);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
    Y = date.getFullYear() + '-';
    M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
    D = date.getDate() + ' ';
    h = date.getHours() + ':';
    m = date.getMinutes() + ':';
    s = date.getSeconds();
    return Y+M+D+h+m+s;
}
var jsonArray = [];
function initEvents() {
    var title,start,end,backgroundColor;
    var json=[];
    $.ajax({
        url: "/calendar/list",
        data: {userId:"test"},
        type: "get",
        // contentType: 'application/json;charset=utf-8',
        success: function (data) { //返回json结果
            var da = data["extend"]["calendars"];

            for (var i in da) {
                title=da[i]["title"];
                start=timestampToTime(parseInt(da[i]["startTime"]));
                end=timestampToTime(parseInt(da[i]["endTime"]));
                backgroundColor="#00FFFF";
                var event={
                    title:title,start:start,end:end,backgroundColor:backgroundColor
                }
                json.push(event);
            }
        }

    })
    return json;
}